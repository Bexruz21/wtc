<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>WebRTC Simple</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: sans-serif;
      min-width: 100%;
      max-width: 100%;
    }

    button {
      display: block;
      padding: 16px 24px;
      height: 60px;
      font-size: 20px;
      cursor: pointer;
      margin: 12px auto;
      text-align: center;
      width: 30%;
    }

    .log {
      margin-top: 8px;
      height: 120px;
      overflow: auto;
      background: #111;
      color: #0f0;
      padding: 8px;
      font-family: monospace;
      font-size: 12px;
    }

    #localVideo {
      transform: scaleX(-1);
    }

    #remoteVideo {
      transform: none;
    }

    .videos {
      display: flex;
      flex-direction: column;
    }

    video {
      width: 100%;
      max-height: 700px;
      object-fit: fill;
      background: #000;
    }
  </style>
</head>

<body>
  <div class="videos">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>
  </div>

  <button id="findBtn">Найти собеседника</button>
  <div class="log" id="log"></div>

  <script>
let ws = null;
let pc = null;
let localStream = null;

const logEl = document.getElementById('log');
const connectBtn = document.getElementById('connectBtn');
const findBtn = document.getElementById('findBtn');

function log(...args){
  console.log(...args);
  logEl.innerText += args.map(a => typeof a==='string'?a:JSON.stringify(a)).join(' ') + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

// ================= WebSocket =================
connectBtn.onclick = () => {
  const url = prompt("Enter WS URL:", "wss://5420f9881077.ngrok-free.app");
  if(!url) return;
  ws = new WebSocket(url);

  ws.onopen = () => {
    log("wsConnected:", url);
    findBtn.disabled = false;
  };

  ws.onmessage = async (ev) => {
    try{
      const msg = JSON.parse(ev.data);
      log("<<", msg.type);

      if(msg.type === "found") {
        log("Peer found! Requesting media...");
        await startLocalMedia();
        await ensurePc();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify(pc.localDescription));
        log(">> sent offer");
      } else if(msg.type === "offer") {
        await ensurePc();
        await pc.setRemoteDescription(msg);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify(pc.localDescription));
        log(">> sent answer");
      } else if(msg.type === "answer") {
        await pc.setRemoteDescription(msg);
        log("Applied remote answer");
      } else if(msg.type === "candidate") {
        await pc.addIceCandidate(msg.candidate);
        log("Added remote candidate");
      }
    } catch(e){
      log("Message parse error", e);
    }
  };

  ws.onclose = () => log("wsClosed");
  ws.onerror = (e) => log("wsError", e);
};

// ================= Peer Connection =================
async function ensurePc(){
  if(pc) return;
  pc = new RTCPeerConnection({ iceServers:[{urls:"stun:stun.l.google.com:19302"}] });

  pc.onicecandidate = e => {
    if(e.candidate && ws && ws.readyState===WebSocket.OPEN){
      ws.send(JSON.stringify({type:"candidate", candidate:e.candidate}));
    }
  };

  pc.ontrack = e => {
    document.getElementById('remoteVideo').srcObject = e.streams[0];
    log("ontrack — remote stream received");
  };

  pc.onconnectionstatechange = () => {
    log("PC state:", pc.connectionState);
  };

  if(localStream){
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  }
}

async function startLocalMedia(){
  if(localStream) return;
  try{
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    document.getElementById('localVideo').srcObject = localStream;
    log("Local media started");
  } catch(e){
    log("getUserMedia error", e);
    alert("Cannot access camera/microphone");
  }
}

// ================= Find Peer =================
findBtn.onclick = async () => {
  if(!ws || ws.readyState!==WebSocket.OPEN){ alert("WS not connected"); return; }
  await startLocalMedia();
  ws.send(JSON.stringify({type:"find"}));
  log("Searching for peer...");
};
</script>
</body>

</html>