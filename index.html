<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>WebRTC Simple</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: sans-serif;
      min-width: 100%;
      max-width: 100%;
    }

    button {
      display: block;
      padding: 16px 24px;
      height: 60px;
      font-size: 20px;
      cursor: pointer;
      margin: 12px auto;
      text-align: center;
      width: 30%;
    }

    .log {
      margin-top: 8px;
      height: 120px;
      overflow: auto;
      background: #111;
      color: #0f0;
      padding: 8px;
      font-family: monospace;
      font-size: 12px;
      display: none;
    }

    #localVideo {
      transform: scaleX(-1);
    }

    #remoteVideo {
      transform: scaleX(-1);
    }

    .videos {
      display: flex;
      flex-direction: column;
    }

    video {
      width: 100%;
      max-height: 700px;
      object-fit: fill;
      background: #000;
    }
  </style>
</head>

<body>
  <h2>WebRTC Video Chat</h2>
  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <script>
    const roomId = "room123"; // Все заходят в одну комнату
    const ws = new WebSocket("wss://07d6f16c7409.ngrok-free.app");

    let pc;

    ws.onopen = () => {
      console.log("✅ Connected to signaling server");
      ws.send(JSON.stringify({ type: "join", room: roomId }));
      start();
    };

    ws.onmessage = async (event) => {
      const data = JSON.parse(event.data);

      if (data.type === "offer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify(pc.localDescription));
      } else if (data.type === "answer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data));
      } else if (data.type === "candidate") {
        try {
          await pc.addIceCandidate(data.candidate);
        } catch (e) {
          console.error("Error adding candidate", e);
        }
      }
    };

    async function start() {
      pc = new RTCPeerConnection();

      pc.onicecandidate = ({ candidate }) => {
        if (candidate) {
          ws.send(JSON.stringify({ type: "candidate", candidate }));
        }
      };

      pc.ontrack = (event) => {
        document.getElementById("remoteVideo").srcObject = event.streams[0];
      };

      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById("localVideo").srcObject = stream;
      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      // Сделаем offer только когда мы первые
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.send(JSON.stringify(pc.localDescription));
    }
  </script>
</body>
</html>