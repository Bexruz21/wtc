<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>WebRTC Simple</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: sans-serif;
      min-width: 100%;
      max-width: 100%;
    }

    button {
      display: block;
      padding: 16px 24px;
      height: 60px;
      font-size: 20px;
      cursor: pointer;
      margin: 12px auto;
      text-align: center;
      width: 30%;
    }

    .log {
      margin-top: 8px;
      height: 120px;
      overflow: auto;
      background: #111;
      color: #0f0;
      padding: 8px;
      font-family: monospace;
      font-size: 12px;
    }

    #localVideo {
      transform: scaleX(-1);
    }

    #remoteVideo {
      transform: none;
    }

    .videos {
      display: flex;
      flex-direction: column;
    }

    video {
      width: 100%;
      max-height: 600px;
      object-fit: fill;
      background: #000;
    }
  </style>
</head>

<body>
  <div class="videos">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>
  </div>

  <button id="findBtn">Найти собеседника</button>
  <!-- <div class="log" id="log"></div> -->

  <script>
    let ws = null;
    let pc = null;
    let localStream = null;

    const logEl = document.getElementById('log');
    const findBtn = document.getElementById('findBtn');

    function log(...args) {
      console.log(...args);
      logEl.innerText += args.join(' ') + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    // --- WebSocket connect & create PeerConnection ---
    async function startCall() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
        log('Local media started');

        ws = new WebSocket('wss://b3aa794a676f.ngrok-free.app');
        ws.onopen = () => log('WS connected');
        ws.onmessage = async (ev) => {
          const msg = JSON.parse(ev.data);
          if (msg.type === 'offer') {
            await ensurePc();
            await pc.setRemoteDescription(msg);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify(pc.localDescription));
          } else if (msg.type === 'answer') {
            if (pc) await pc.setRemoteDescription(msg);
          } else if (msg.type === 'candidate') {
            if (pc) await pc.addIceCandidate(msg.candidate);
          }
        };

        await ensurePc();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify(pc.localDescription));
      } catch (e) {
        log('Error:', e.name || e.message);
      }
    }

    async function ensurePc() {
      if (pc) return;
      pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
      pc.onicecandidate = e => {
        if (e.candidate && ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate }));
      };
      pc.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; };
      if (localStream) localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    }

    findBtn.onclick = startCall;
  </script>
</body>

</html>