<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>WebRTC Chat Roulette</title>
<style>
  body { font-family: Inter, system-ui, sans-serif; padding: 18px; max-width: 900px; margin: 0 auto; }
  video { width:48%; border-radius:6px; border:1px solid #222; background:#000; }
  #videos { display:flex; gap:12px; margin-top:12px; justify-content:center; }
  button { padding:10px 16px; margin-top:12px; cursor:pointer; font-size:16px; }
  #log { margin-top:12px; height:120px; overflow:auto; background:#111; color:#0f0; padding:8px; font-family: monospace; font-size:12px; }
</style>
</head>
<body>
<h1>WebRTC Chat Roulette</h1>
<div id="videos">
  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>
</div>

<button id="findBtn" disabled>Найти собеседника</button>
<div id="log"></div>

<script>
let ws = null;
let pc = null;
let localStream = null;

const logEl = document.getElementById("log");
const findBtn = document.getElementById("findBtn");

function log(...args){
  console.log(...args);
  logEl.innerText += args.map(a => typeof a === "string" ? a : JSON.stringify(a)).join(" ") + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

// =================== WS ===================
function connectWS(){
  const url = "wss://YOUR_NGROK_OR_DOMAIN"; // вставь свой WebSocket
  ws = new WebSocket(url);

  ws.onopen = () => { log("WS connected"); findBtn.disabled = false; };
  ws.onmessage = async (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if(msg.type === "offer"){
        await ensurePc();
        await pc.setRemoteDescription(msg);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify(pc.localDescription));
        log(">> sent answer");
      } else if(msg.type === "answer"){
        await pc.setRemoteDescription(msg);
        log("Applied remote answer");
      } else if(msg.type === "candidate"){
        await pc.addIceCandidate(msg.candidate);
        log("Added remote candidate");
      }
    } catch(e){ log("parse message error", e); }
  };
  ws.onclose = () => log("WS closed");
  ws.onerror = e => log("WS error", e);
}

// =================== WebRTC ===================
async function ensurePc(){
  if(pc) return;
  pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });

  pc.onicecandidate = e => {
    if(e.candidate && ws && ws.readyState === WebSocket.OPEN){
      ws.send(JSON.stringify({ type:"candidate", candidate:e.candidate }));
    }
  };

  pc.ontrack = e => { document.getElementById("remoteVideo").srcObject = e.streams[0]; log("ontrack — got remote stream"); };

  if(localStream){
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  }
}

// =================== Auto start camera ===================
window.addEventListener("load", async () => {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    document.getElementById("localVideo").srcObject = localStream;
    log("Local media started automatically");
    await ensurePc();
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    connectWS();
  } catch(e){
    log("getUserMedia error", e);
    alert("Нужен доступ к камере/микрофону!");
  }
});

// =================== Find Partner ===================
findBtn.onclick = async () => {
  if(!ws || ws.readyState !== WebSocket.OPEN){ alert("WS не подключён"); return; }
  await ensurePc();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify(pc.localDescription));
  log(">> sent offer (find partner)");
};
</script>
</body>
</html>
