<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>WebRTC Simple</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: sans-serif;
      min-width: 100%;
      max-width: 100%;
    }

    button {
      display: block;
      padding: 16px 24px;
      height: 60px;
      font-size: 20px;
      cursor: pointer;
      margin: 12px auto;
      text-align: center;
      width: 30%;
    }

    .log {
      margin-top: 8px;
      height: 120px;
      overflow: auto;
      background: #111;
      color: #0f0;
      padding: 8px;
      font-family: monospace;
      font-size: 12px;
    }

    #localVideo {
      transform: scaleX(-1);
    }

    #remoteVideo {
      transform: none;
    }

    .videos {
      display: flex;
      flex-direction: column;
    }

    video {
      width: 100%;
      max-height: 700px;
      object-fit: fill;
      background: #000;
    }
  </style>
</head>

<body>
  <button id="findBtn">üîç Find Peer</button>
  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>
  <div class="log" id="log"></div>

  <script>
    const log = (msg) => {
      console.log(msg);
      document.getElementById("log").innerHTML += msg + "<br>";
    };

    const ws = new WebSocket("wss://aec36efaefbf.ngrok-free.app "); // —Ç–≤–æ–π ngrok
    let pc;

    ws.onopen = () => log("‚úÖ wsConnected");
    ws.onmessage = async (event) => {
      let data;
      try {
        data = JSON.parse(event.data);
      } catch (e) {
        log("‚ùå parse error: " + event.data);
        return;
      }

      if (data.type === "found") {
        log("<< found");
        startPeer();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: "offer", sdp: offer.sdp }));
        log(">> sent offer");
      } else if (data.type === "offer") {
        log("<< got offer");
        startPeer();
        await pc.setRemoteDescription({ type: "offer", sdp: data.sdp });
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: "answer", sdp: answer.sdp }));
        log(">> sent answer");
      } else if (data.type === "answer") {
        log("<< got answer");
        await pc.setRemoteDescription({ type: "answer", sdp: data.sdp });
      } else if (data.type === "candidate") {
        log("<< got candidate");
        try {
          await pc.addIceCandidate(data.candidate);
        } catch (e) {
          console.error("ICE error", e);
        }
      }
    };

    document.getElementById("findBtn").onclick = () => {
      ws.send(JSON.stringify({ type: "find" }));
      log("Searching for peer...");
    };

    function startPeer() {
      if (pc) return;
      pc = new RTCPeerConnection();

      pc.onicecandidate = (e) => {
        if (e.candidate) {
          ws.send(JSON.stringify({ type: "candidate", candidate: e.candidate }));
          log(">> sent candidate");
        }
      };

      pc.ontrack = (e) => {
        log("Remote stream started");
        document.getElementById("remoteVideo").srcObject = e.streams[0];
      };

      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then((stream) => {
          document.getElementById("localVideo").srcObject = stream;
          stream.getTracks().forEach((track) => pc.addTrack(track, stream));
          log("Local media started");
        })
        .catch((err) => {
          log("getUserMedia error " + JSON.stringify(err));
        });
    }
  </script>
</body>

</html>